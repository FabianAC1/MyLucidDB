<project name="fennel_common_resources" default="generate.resources">

  <!--
  // Licensed to DynamoBI Corporation (DynamoBI) under one
  // or more contributor license agreements.  See the NOTICE file
  // distributed with this work for additional information
  // regarding copyright ownership.  DynamoBI licenses this file
  // to you under the Apache License, Version 2.0 (the
  // "License"); you may not use this file except in compliance
  // with the License.  You may obtain a copy of the License at

  //   http:www.apache.org/licenses/LICENSE-2.0

  // Unless required by applicable law or agreed to in writing,
  // software distributed under the License is distributed on an
  // "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  // KIND, either express or implied.  See the License for the
  // specific language governing permissions and limitations
  // under the License.
  -->


  <property name="resource.name" value="FennelResource"/>
  <property name="resource.locales" value="en_US"/>

  <property name="perforce.view" value="."/>

  <property
    name="perforce.files"
    value="
${perforce.view}/${resource.name}.h
${perforce.view}/${resource.name}.cpp
${perforce.view}/${resource.name}*.properties
"/>

  <target
    name="generate.resources"
    description="Regenerate, if necessary, the Fennel Resource header and implementation and the associated properties files.">

    <!-- We attempt to avoid re-generating files when they don't need it.
         The rationale is to avoid no-op perforce changelist creation and
         submission. (Normally testing is handled by make, but someone might
         run this script directly). This condition isn't entirely correct: it
         should check all ${resource.name}*.properties files, but the 
         uptodate task doesn't provide a means to do that. -->
    <condition property="subroutine" value="execute.resgen">
      <not>
        <and>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.h"/>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.cpp"/>
          <uptodate srcfile="${resource.name}.xml" targetfile="${resource.name}.properties"/>
        </and>
      </not>
    </condition>

    <!-- If the property wasn't just set, set it now. -->
    <condition property="subroutine" value="skip.resgen">
      <not>
        <isset property="subroutine"/>
      </not>
    </condition>

    <antcall target="${subroutine}"/>
  </target>

  <path id="resgen.classpath">
    <pathelement location="../../thirdparty/resgen/lib/eigenbase-resgen.jar"/>
    <pathelement location="../../thirdparty/resgen/lib/eigenbase-xom.jar"/>
  </path>

  <target name="execute.resgen">
    <taskdef name="resgen" classname="org.eigenbase.resgen.ResourceGenTask"
      classpathref="resgen.classpath"/>

    <antcall target="checkout.files"/>

    <resgen mode="c++" srcdir="./" locales="${resource.locales}" commentstyle="scm-safe">
      <include name="${resource.name}.xml"/>
    </resgen>
  </target>

  <target name="checkout.files" unless="skip.checkout">
    <echo>Automatically adding files generated by ResGen to the default changelist:</echo>

    <p4edit view="${perforce.files}"/>
  </target>

  <target name="skip.resgen">
    <echo>Skipping resource generation: nothing to do.</echo>
  </target>
</project>
